AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    AutoPublishAlias: live
    Handler: index.handler
    MemorySize: 256
    Runtime: python3.13
    Timeout: 120
    Tracing: Active
    Environment:
      Variables:
        CORE_TABLE_NAME:
          Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTableName"   
        COGNITO_USER_POOL_ID:
          Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"
        TAG_APP_VALUE: !Ref AppValue
        APP_NAME: !Ref ProjectName
        ENVIRONMENT_NAME: !Ref EnvironmentName
        AWS_REGION_NAME: !Sub "${AWS::Region}"

Parameters:
  ProjectName:
    Type: String
  EnvironmentName:
    Type: String
  AppValue:
    Type: String
  IAMEC2RoleArn:
    Type: String
    Description: IAM EC2 Role ARN
  IAMEC2InstanceProfile:
    Type: String
    Description: IAM EC2 Instance Profile Name
  IAMEC2InstanceProfileArn:
    Type: String
    Description: IAM EC2 Instance Profile ARN
  SupportBucket:
    Type: String
    Description: S3 Support Bucket Name
  DefaultSubnetIds:
    Type: CommaDelimitedList
    Description: Comma-separated list of subnet IDs for EC2 instances
  DefaultSecurityGroupId:
    Type: String
    Description: Default security group for EC2 instances
Resources:

  ec2ActionValidatorQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${ProjectName}-${EnvironmentName}-ec2-actions"
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ec2ActionValidatorDLQ.Arn
        maxReceiveCount: 3

  ec2ActionValidatorDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${ProjectName}-${EnvironmentName}-ec2-actions-dlq"
      MessageRetentionPeriod: 1209600

  GraphQLAPI:
    Type: AWS::Serverless::GraphQLApi
    Properties:
      Name: !Sub "${ProjectName}-${EnvironmentName}-graphql"
      SchemaUri: ../../appsync/schema.graphql
      Auth:
        Type: "AMAZON_COGNITO_USER_POOLS"
        UserPool:
          UserPoolId: 
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"
          AwsRegion: !Ref "AWS::Region"
          DefaultAction: ALLOW
        Additional:
          - Type: AWS_IAM
      DataSources:
        DynamoDb:
          LogAuditTable:
            TableName: 
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTableName"
            TableArn:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTable"
          CoreTable:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
            TableArn:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
        Lambda:
          ec2DiscoveryDataSource:
            FunctionArn: !GetAtt ec2Discovery.Arn
          ec2ActionValidatorDataSource:
            FunctionArn: !GetAtt ec2ActionValidator.Arn
          iamProfileManagerDataSource:
            FunctionArn: !GetAtt iamProfileManager.Arn
          ec2MetricsHandlerDataSource:
            FunctionArn: !GetAtt ec2MetricsHandler.Arn
          getServerLogsDataSource:
            FunctionArn: !GetAtt getServerLogs.Arn
      Functions:
        serverListFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ec2DiscoveryDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        ec2ActionValidatorFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ec2ActionValidatorDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        iamProfileManagerFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: iamProfileManagerDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        ec2MetricsHandlerFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ec2MetricsHandlerDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        getServerLogsFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: getServerLogsDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        putLogAuditFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: LogAuditTable
          CodeUri: ../../appsync/resolvers/putById.js
        getLogAuditFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: LogAuditTable
          CodeUri: ../../appsync/resolvers/getById.js
        putServerRecordFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: CoreTable
          CodeUri: ../../appsync/resolvers/putById.js
        getServerRecordFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: CoreTable
          CodeUri: ../../appsync/resolvers/getById.js
      Resolvers:
        Mutation: 
          putServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          updateServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          startServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          stopServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          restartServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          createServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          iamProfileManager:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - iamProfileManagerFunction
          addUserToServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          updateUserRole:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          removeUserFromServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          updateServerName:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          putLogAudit:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - putLogAuditFunction
          verifyUserEmail:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getLogAuditFunction
        Query:
          ec2Discovery:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverListFunction     
          getServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          getServerUsers:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          searchUserByEmail:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2ActionValidatorFunction
          getLogAudit:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getLogAuditFunction
          getServerLogs:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getServerLogsFunction
          ec2MetricsHandler:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - ec2MetricsHandlerFunction

  DataSourceNone:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      Name: dataSourceNameNone
      Description: dataSourceNone
      Type: "NONE"

  PutMetricServerResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      TypeName: Mutation
      FieldName: putServerMetric
      DataSourceName: !GetAtt DataSourceNone.Name
      RequestMappingTemplate: |
        {
          "version" : "2017-02-28",
          "payload": { 
              "id": $util.toJson($context.arguments.input.id),
              "cpuStats": $util.toJson($context.arguments.input.cpuStats),
              "networkStats": $util.toJson($context.arguments.input.networkStats),
              "memStats": $util.toJson($context.arguments.input.memStats),
              "activeUsers": $util.toJson($context.arguments.input.activeUsers),
          }
        }
      ResponseMappingTemplate: $util.toJson($ctx.result)

  ChangeServerStateResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      TypeName: Mutation
      FieldName: changeServerState
      DataSourceName: !GetAtt DataSourceNone.Name
      RequestMappingTemplate: |
        {
          "version" : "2017-02-28",
          "payload": { 
              "id": $util.toJson($context.arguments.input.id),
              "name": $util.toJson($context.arguments.input.name),
              "type": $util.toJson($context.arguments.input.type),
              "userEmail": $util.toJson($context.arguments.input.userEmail),
              "state": $util.toJson($context.arguments.input.state),
              "vCpus": $util.toJson($context.arguments.input.vCpus),
              "memSize": $util.toJson($context.arguments.input.memSize),
              "diskSize": $util.toJson($context.arguments.input.diskSize),
              "launchTime": $util.toJson($context.arguments.input.launchTime),
              "publicIp": $util.toJson($context.arguments.input.publicIp),
              "initStatus": $util.toJson($context.arguments.input.initStatus),
              "iamStatus": $util.toJson($context.arguments.input.iamStatus),
              "runningMinutes": $util.toJson($context.arguments.input.runningMinutes),
              "runningMinutesCacheTimestamp": $util.toJson($context.arguments.input.runningMinutesCacheTimestamp),
              "groupMembers": $util.toJson($context.arguments.input.groupMembers)
          }
        }
      ResponseMappingTemplate: $util.toJson($ctx.result)

  ScheduledRule: 
    Type: AWS::Events::Rule
    Properties: 
      Description: "ScheduledRule"
      ScheduleExpression: "rate(2 minutes)"
      State: "DISABLED"
      Targets: 
        - 
          Arn: !GetAtt ec2StateHandler.Arn              
          Id: "ec2StateHandlerV1"

  ScheduledRuleParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${ProjectName}/${EnvironmentName}/scheduledrule
      Type: String
      Value: !Ref ScheduledRule
      Description: ScheduledRule

  PermissionForEventsToInvokeLambda: 
    Type: AWS::Lambda::Permission
    Properties: 
      FunctionName: !Ref "ec2StateHandler"
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: 
        !GetAtt ScheduledRule.Arn

  MonthlyRuntimeCalculationRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "Trigger monthly runtime calculation every hour"
      ScheduleExpression: "rate(1 hour)"
      State: "ENABLED"
      Targets:
        - Arn: !GetAtt CalculateMonthlyRuntime.Arn
          Id: "CalculateMonthlyRuntimeV1"

  PermissionForMonthlyRuntimeRule:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CalculateMonthlyRuntime
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt MonthlyRuntimeCalculationRule.Arn

  AuthLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelper
      ContentUri: ../../layers/authHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  DdbLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelpers
      ContentUri: ../../layers/ddbHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  UtilLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelper
      ContentUri: ../../layers/utilHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  Ec2Layer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelpers
      ContentUri: ../../layers/ec2Helper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  ErrorLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: SSM Command Helper
      ContentUri: ../../layers/errorHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  ec2StateHandler:
    Type: AWS::Serverless::Function 
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-ec2StateHandler"
      CodeUri: ../../lambdas/ec2StateHandler/
      Layers:
        - !Ref AuthLayer
        - !Ref DdbLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer
      Events:
        EC2StateTrigger:
          Type: CloudWatchEvent 
          Properties:
            Pattern:
              source:
                - aws.ec2
              detail-type:
                - EC2 Instance State-change Notification                
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"
        - Version: '2012-10-17' # Policy Document for Cognito Group Management
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:CreateGroup
                - cognito-idp:GetGroup
              Resource: !Sub 'arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - logs:Get*
                - logs:List*
                - logs:StartQuery
              Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/minecraft/*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - appsync:ListGraphqlApis
                - appsync:GetGraphqlApi
                - appsync:GraphQL
              Resource: '*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - events:ListRules
                - events:DescribeRule
                - events:DisableRule
                - events:EnableRule
              Resource: "*"
        - Version: '2012-10-17' # Policy Document for UserMembership DynamoDB
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
      Environment:
        Variables:
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          COGNITO_USER_POOL_ID: 
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"
          CORE_TABLE_NAME:
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTableName"

  ec2MetricsHandler:
    Type: AWS::Serverless::Function 
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-ec2MetricsHandler"
      CodeUri: ../../lambdas/ec2MetricsHandler/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess


  ec2Discovery:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-ec2Discovery"
      CodeUri: ../../lambdas/ec2Discovery/
      Layers:
        - !Ref AuthLayer
        - !Ref Ec2Layer
        - !Ref DdbLayer
        - !Ref ErrorLayer
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:Query
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"

  getServerLogs:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-getServerLogs"
      CodeUri: ../../lambdas/getServerLogs/
      Layers:
        - !Ref AuthLayer
        - !Ref Ec2Layer
        - !Ref UtilLayer
        - !Ref DdbLayer
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"
          CORE_TABLE_NAME:
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTableName"
          LOG_SERVICE_PORT: "25566"
      Policies:
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"

  ec2ActionWorker:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 300
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-ec2ActionWorker"
      CodeUri: ../../lambdas/ec2ActionWorker/
      Layers:
        - !Ref UtilLayer
        - !Ref Ec2Layer
        - !Ref DdbLayer
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt ec2ActionValidatorQueue.Arn
            BatchSize: 1
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTable"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ec2:StartInstances
                - ec2:StopInstances
                - ec2:RebootInstances
                - ec2:CreateTags
                - ec2:DeleteTags
              Resource: 'arn:aws:ec2:*:*:instance/*'
              Condition:
                StringEquals:
                  'ec2:ResourceTag/App': !Ref AppValue
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ec2:RunInstances
              Resource:
                - 'arn:aws:ec2:*:*:instance/*'
                - 'arn:aws:ec2:*:*:volume/*'
                - 'arn:aws:ec2:*:*:network-interface/*'
                - 'arn:aws:ec2:*:*:security-group/*'
                - 'arn:aws:ec2:*:*:subnet/*'
                - 'arn:aws:ec2:*::image/*'
            - Effect: Allow
              Action:
                - ec2:CreateTags
              Resource:
                - 'arn:aws:ec2:*:*:instance/*'
                - 'arn:aws:ec2:*:*:volume/*'
              Condition:
                StringEquals:
                  'ec2:CreateAction': 'RunInstances'
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2RoleArn"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - events:PutRule
                - events:PutTargets
                - events:DeleteRule
                - events:RemoveTargets
                - events:DisableRule
                - events:EnableRule
                - events:ListRules
                - events:ListTargetsByRule
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricAlarm
                - cloudwatch:DeleteAlarms
                - cloudwatch:DescribeAlarms
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - appsync:ListGraphqlApis
                - appsync:GetGraphqlApi
                - appsync:GraphQL
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource:
                - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/minecraft-dashboard/notification-sender-email"
                - !Sub "arn:aws:ssm:${AWS::Region}::parameter/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id"
      Environment:
        Variables:
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          LOG_AUDIT_TABLE_NAME:
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTableName"
          EC2_INSTANCE_PROFILE_ARN: !Ref IAMEC2InstanceProfileArn
          EC2_INSTANCE_PROFILE_NAME: !Ref IAMEC2InstanceProfile
          SUPPORT_BUCKET: !Ref SupportBucket
          AWS_ACCOUNT_ID: !Sub "${AWS::AccountId}"
          DEFAULT_SUBNET_IDS: !Join [',', !Ref DefaultSubnetIds]
          DEFAULT_SECURITY_GROUP_ID: !Ref DefaultSecurityGroupId

  ec2ActionValidator:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 30
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-ec2ActionValidator"
      CodeUri: ../../lambdas/ec2ActionValidator/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer  
        - !Ref DdbLayer      
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"        
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
              Resource:
                - Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
                - Fn::Sub:
                    - "${CoreTable}/index/*"
                    - CoreTable:
                        Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
                - Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTable"
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - ssm:PutParameter
                - ssm:GetParameters
              Resource: !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/minecraftserverdashboard*
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:CreateGroup
                - cognito-idp:AdminAddUserToGroup
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt ec2ActionValidatorQueue.Arn
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource: !Sub "${GraphQLAPI.Arn}/*"
      Environment:
        Variables:
          EC2_INSTANCE_PROFILE_NAME:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2InstanceProfile"
          EC2_INSTANCE_PROFILE_ARN:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2InstanceProfileArn"
          SERVER_ACTION_QUEUE_URL: !Ref ec2ActionValidatorQueue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          COGNITO_USER_POOL_ID:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"

  PermissionForScheduledEventsToInvokeec2ActionValidator:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ec2ActionValidator
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*"

  iamProfileManager:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 120
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-iamProfileManager"
      CodeUri: ../../lambdas/iamProfileManager/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ec2:AssociateIamInstanceProfile
                - ec2:DisassociateIamInstanceProfile
              Resource: 'arn:aws:ec2:*:*:instance/*'
              Condition:
                StringEquals:
                  'ec2:ResourceTag/App': !Ref AppValue
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !Ref IAMEC2RoleArn
      Environment:
        Variables:
          EC2_INSTANCE_PROFILE_NAME: !Ref IAMEC2InstanceProfile
          EC2_INSTANCE_PROFILE_ARN: !Ref IAMEC2InstanceProfileArn
          COGNITO_USER_POOL_ID:
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"

  CalculateMonthlyRuntime:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 300
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-calculateEc2MonthlyRuntime"
      CodeUri: ../../lambdas/calculateEc2MonthlyRuntime/
      Layers:
        - !Ref Ec2Layer
        - !Ref DdbLayer
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"


Outputs:
  GraphQLAPIEndpoint:
    Value: !GetAtt GraphQLAPI.GraphQLUrl
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-GraphQLAPIEndpoint"

  GraphQLAPIId:
    Value: !GetAtt GraphQLAPI.ApiId
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-GraphQLAPIId"

  # ConfigServer output removed as Lambda is no longer needed

  ec2MetricsHandler:
    Value: !GetAtt ec2MetricsHandler.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-ec2MetricsHandler"

  ec2Discovery:
    Value: !GetAtt ec2Discovery.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-ec2Discovery"

  ec2ActionValidator:
    Value: !GetAtt ec2ActionValidator.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-ec2ActionValidator"

  iamProfileManager:
    Value: !GetAtt iamProfileManager.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-iamProfileManager"

  ec2StateHandler:
    Value: !GetAtt ec2StateHandler.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-ec2StateHandler"

  CalculateMonthlyRuntime:
    Value: !GetAtt CalculateMonthlyRuntime.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-CalculateMonthlyRuntime"
