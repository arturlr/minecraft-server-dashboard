AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    AutoPublishAlias: live
    Handler: index.handler
    MemorySize: 256
    Runtime: python3.13
    Timeout: 120
    Tracing: Active
    Environment:
      Variables:
        CORE_TABLE_NAME:
          Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"   
        TAG_APP_VALUE: !Ref AppValue
        APP_NAME: !Ref ProjectName
        ENVIRONMENT_NAME: !Ref EnvironmentName
        AWS_REGION_NAME: !Sub "${AWS::Region}"

Parameters:
  ProjectName:
    Type: String
  EnvironmentName:
    Type: String
  AppValue:
    Type: String
  BootstrapSSMDoc:
    Type: String
    Description: Bootstrap SSM Document Name

Resources:

  ServerActionQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${ProjectName}-${EnvironmentName}-server-actions"
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ServerActionDLQ.Arn
        maxReceiveCount: 3

  ServerActionDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${ProjectName}-${EnvironmentName}-server-actions-dlq"
      MessageRetentionPeriod: 1209600

  SSMCommandQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${ProjectName}-${EnvironmentName}-ssm-commands"
      VisibilityTimeout: 900  # 15 minutes
      MessageRetentionPeriod: 86400  # 24 hours
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt SSMCommandDLQ.Arn
        maxReceiveCount: 3

  SSMCommandDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${ProjectName}-${EnvironmentName}-ssm-commands-dlq"
      MessageRetentionPeriod: 1209600  # 14 days

  GraphQLAPI:
    Type: AWS::Serverless::GraphQLApi
    Properties:
      Name: !Sub "${ProjectName}-${EnvironmentName}-graphql"
      SchemaUri: ../../appsync/schema.graphql
      Auth:
        Type: "AMAZON_COGNITO_USER_POOLS"
        UserPool:
          UserPoolId: 
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"
          AwsRegion: !Ref "AWS::Region"
          DefaultAction: ALLOW
        Additional:
          - Type: AWS_IAM
      DataSources:
        DynamoDb:
          LogAuditTable:
            TableName: 
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTableName"
            TableArn:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTable"
          CoreTable:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
            TableArn:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
        Lambda:
          ListServersDataSource:
            FunctionArn: !GetAtt ListServers.Arn
          ServerActionDataSource:
            FunctionArn: !GetAtt ServerAction.Arn
          FixServerRoleDataSource:
            FunctionArn: !GetAtt FixServerRole.Arn
          GetMonthlyCostDataSource:
            FunctionArn: !GetAtt GetMonthlyCost.Arn
          GetServerMetricsDataSource:
            FunctionArn: !GetAtt GetServerMetrics.Arn
      Functions:
        serverListFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ListServersDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        serverActionFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ServerActionDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        fixServerRoleFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: FixServerRoleDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        getMonthlyCostFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: GetMonthlyCostDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        getServerMetricsFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: GetServerMetricsDataSource
          CodeUri: ../../appsync/resolvers/lambdaInvoker.js
        putLogAuditFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: LogAuditTable
          CodeUri: ../../appsync/resolvers/putById.js
        getLogAuditFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: LogAuditTable
          CodeUri: ../../appsync/resolvers/getById.js
        putServerRecordFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: CoreTable
          CodeUri: ../../appsync/resolvers/putById.js
        getServerRecordFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: CoreTable
          CodeUri: ../../appsync/resolvers/getById.js
      Resolvers:
        Mutation: 
          putServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          updateServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          startServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          stopServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          restartServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          createServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          fixServerRole:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - fixServerRoleFunction
          addUserToServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          updateUserRole:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          removeUserFromServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          updateServerName:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          putLogAudit:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - putLogAuditFunction
          verifyUserEmail:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getLogAuditFunction
        Query:
          listServers:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverListFunction     
          getServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          getServerUsers:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          searchUserByEmail:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverActionFunction
          getMonthlyCost:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getMonthlyCostFunction
          getLogAudit:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getLogAuditFunction
          getServerMetrics:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getServerMetricsFunction

  DataSourceNone:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      Name: dataSourceNameNone
      Description: dataSourceNone
      Type: "NONE"

  PutMetricServerResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      TypeName: Mutation
      FieldName: putServerMetric
      DataSourceName: !GetAtt DataSourceNone.Name
      RequestMappingTemplate: |
        {
          "version" : "2017-02-28",
          "payload": { 
              "id": $util.toJson($context.arguments.input.id),
              "cpuStats": $util.toJson($context.arguments.input.cpuStats),
              "networkStats": $util.toJson($context.arguments.input.networkStats),
              "memStats": $util.toJson($context.arguments.input.memStats),
              "activeUsers": $util.toJson($context.arguments.input.activeUsers),
          }
        }
      ResponseMappingTemplate: $util.toJson($ctx.result)

  ChangeServerStateResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      TypeName: Mutation
      FieldName: changeServerState
      DataSourceName: !GetAtt DataSourceNone.Name
      RequestMappingTemplate: |
        {
          "version" : "2017-02-28",
          "payload": { 
              "id": $util.toJson($context.arguments.input.id),
              "name": $util.toJson($context.arguments.input.name),
              "type": $util.toJson($context.arguments.input.type),
              "userEmail": $util.toJson($context.arguments.input.userEmail),
              "state": $util.toJson($context.arguments.input.state),
              "vCpus": $util.toJson($context.arguments.input.vCpus),
              "memSize": $util.toJson($context.arguments.input.memSize),
              "diskSize": $util.toJson($context.arguments.input.diskSize),
              "launchTime": $util.toJson($context.arguments.input.launchTime),
              "publicIp": $util.toJson($context.arguments.input.publicIp),
              "initStatus": $util.toJson($context.arguments.input.initStatus),
              "iamStatus": $util.toJson($context.arguments.input.iamStatus),
              "runningMinutes": $util.toJson($context.arguments.input.runningMinutes),
              "runningMinutesCacheTimestamp": $util.toJson($context.arguments.input.runningMinutesCacheTimestamp),
              "groupMembers": $util.toJson($context.arguments.input.groupMembers)
          }
        }
      ResponseMappingTemplate: $util.toJson($ctx.result)

  ScheduledRule: 
    Type: AWS::Events::Rule
    Properties: 
      Description: "ScheduledRule"
      ScheduleExpression: "rate(2 minutes)"
      State: "DISABLED"
      Targets: 
        - 
          Arn: !GetAtt EventResponse.Arn              
          Id: "EventResponseV1"

  ScheduledRuleParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${ProjectName}/${EnvironmentName}/scheduledrule
      Type: String
      Value: !Ref ScheduledRule
      Description: ScheduledRule

  PermissionForEventsToInvokeLambda: 
    Type: AWS::Lambda::Permission
    Properties: 
      FunctionName: !Ref "EventResponse"
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: 
        !GetAtt ScheduledRule.Arn

  MonthlyRuntimeCalculationRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "Trigger monthly runtime calculation every hour"
      ScheduleExpression: "rate(1 hour)"
      State: "ENABLED"
      Targets:
        - Arn: !GetAtt CalculateMonthlyRuntime.Arn
          Id: "CalculateMonthlyRuntimeV1"

  PermissionForMonthlyRuntimeRule:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CalculateMonthlyRuntime
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt MonthlyRuntimeCalculationRule.Arn

  AuthLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelper
      ContentUri: ../../layers/authHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  DdbLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelpers
      ContentUri: ../../layers/ddbHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  UtilLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelper
      ContentUri: ../../layers/utilHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  Ec2Layer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelpers
      ContentUri: ../../layers/ec2Helper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  SsmLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: SSM Command Helper
      ContentUri: ../../layers/ssmHelper/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  EventResponse:
    Type: AWS::Serverless::Function 
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-eventResponse"
      CodeUri: ../../lambdas/eventResponse/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer
        - !Ref DdbLayer
        - !Ref SsmLayer 
      Events:
        EC2StateTrigger:
          Type: CloudWatchEvent 
          Properties:
            Pattern:
              source:
                - aws.ec2
              detail-type:
                - EC2 Instance State-change Notification                
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"
        - Version: '2012-10-17' # Policy Document for Cognito Group Management
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:CreateGroup
                - cognito-idp:GetGroup
              Resource: !Sub 'arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - logs:Get*
                - logs:List*
                - logs:StartQuery
              Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/minecraft/*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - appsync:ListGraphqlApis
                - appsync:GetGraphqlApi
                - appsync:GraphQL
              Resource: '*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - events:ListRules
                - events:DescribeRule
                - events:DisableRule
                - events:EnableRule
              Resource: "*"
        - Version: "2012-10-17" # Policy Document for SQS
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt SSMCommandQueue.Arn
        - Version: '2012-10-17' # Policy Document for UserMembership DynamoDB
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
      Environment:
        Variables:
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          COGNITO_USER_POOL_ID: 
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"
          BOOTSTRAP_SSM_DOC_NAME: !Ref BootstrapSSMDoc
          SSM_COMMAND_QUEUE_URL: !Ref SSMCommandQueue          

  GetMonthlyCost:
    Type: AWS::Serverless::Function 
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-getMonthlyCost"
      CodeUri: ../../lambdas/getMonthlyCost/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer         
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"

  GetServerMetrics:
    Type: AWS::Serverless::Function 
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-getServerMetrics"
      CodeUri: ../../lambdas/getServerMetrics/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess


  ListServers:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-listServers"
      CodeUri: ../../lambdas/listServers/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer
        - !Ref DdbLayer
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTableName"
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricAlarm
                - events:List*
                - events:Describe*                
              Resource: "*"
      Environment:
        Variables:
          EC2_INSTANCE_PROFILE_ARN: 
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2InstanceProfileArn"
          COGNITO_USER_POOL_ID: 
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"

  ServerActionProcessor:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 300
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-serverActionProcessor"
      CodeUri: ../../lambdas/serverActionProcessor/
      Layers:
        - !Ref UtilLayer
        - !Ref Ec2Layer
        - !Ref DdbLayer
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt ServerActionQueue.Arn
            BatchSize: 1
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ec2:StartInstances
                - ec2:StopInstances
                - ec2:RebootInstances
                - ec2:CreateTags
                - ec2:DeleteTags
              Resource: 'arn:aws:ec2:*:*:instance/*'
              Condition:
                StringEquals:
                  'ec2:ResourceTag/App': !Ref AppValue
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - events:PutRule
                - events:PutTargets
                - events:DeleteRule
                - events:RemoveTargets
                - events:DisableRule
                - events:EnableRule
                - events:ListRules
                - events:ListTargetsByRule
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricAlarm
                - cloudwatch:DeleteAlarms
                - cloudwatch:DescribeAlarms
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - appsync:ListGraphqlApis
                - appsync:GetGraphqlApi
                - appsync:GraphQL
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
              Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/minecraft-dashboard/notification-sender-email"
      Environment:
        Variables:
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl

  ServerBootProcessor:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 60
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-serverBootProcessor"
      CodeUri: ../../lambdas/serverBootProcessor/
      Layers:
        - !Ref Ec2Layer
        - !Ref DdbLayer
      Events:
        EC2StateChange:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source: ["aws.ec2"]
              detail-type: ["EC2 Instance State-change Notification"]
              detail:
                state: ["running"]
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - appsync:ListGraphqlApis
                - appsync:GetGraphqlApi
                - appsync:GraphQL
              Resource: '*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - events:ListRules
                - events:DescribeRule
                - events:DisableRule
                - events:EnableRule
              Resource: "*"
        - Version: "2012-10-17" # Policy Document for SQS
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt SSMCommandQueue.Arn
        - Version: '2012-10-17' # Policy Document for UserMembership DynamoDB
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource:
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
      Environment:
        Variables:
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          COGNITO_USER_POOL_ID: 
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"
          BOOTSTRAP_SSM_DOC_NAME: !Ref BootstrapSSMDoc
          SSM_COMMAND_QUEUE_URL: !Ref SSMCommandQueue   

  ServerAction:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 30
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-serverAction"
      CodeUri: ../../lambdas/serverAction/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer  
        - !Ref DdbLayer      
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"        
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-LogAuditTableName"
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - ssm:PutParameter
                - ssm:GetParameters
              Resource: !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/minecraftserverdashboard*
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:CreateGroup
                - cognito-idp:AdminAddUserToGroup
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt ServerActionQueue.Arn
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - appsync:GraphQL
              Resource: !Sub "${GraphQLAPI.Arn}/*"
      Environment:
        Variables:
          EC2_INSTANCE_PROFILE_NAME:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2InstanceProfile"
          EC2_INSTANCE_PROFILE_ARN:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2InstanceProfileArn"
          SERVER_ACTION_QUEUE_URL: !Ref ServerActionQueue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          COGNITO_USER_POOL_ID:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"

  PermissionForScheduledEventsToInvokeServerAction:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ServerAction
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*"

  FixServerRole:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 120
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-fixServerRole"
      CodeUri: ../../lambdas/fixServerRole/
      Layers:
        - !Ref AuthLayer
        - !Ref UtilLayer
        - !Ref Ec2Layer
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "${ProjectName}*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ec2:AssociateIamInstanceProfile
                - ec2:DisassociateIamInstanceProfile
              Resource: 'arn:aws:ec2:*:*:instance/*'
              Condition:
                StringEquals:
                  'ec2:ResourceTag/App': !Ref AppValue
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: 
                Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2RoleArn"
      Environment:
        Variables:
          EC2_INSTANCE_PROFILE_NAME:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2InstanceProfile"
          EC2_INSTANCE_PROFILE_ARN:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-IAMEC2InstanceProfileArn"
          COGNITO_USER_POOL_ID:  
            Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-UserPoolId"

  CalculateMonthlyRuntime:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 300
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-calculateMonthlyRuntime"
      CodeUri: ../../lambdas/calculateMonthlyRuntime/
      Layers:
        - !Ref Ec2Layer
        - !Ref DdbLayer
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - DynamoDBCrudPolicy:
            TableName:
              Fn::ImportValue: !Sub "${ProjectName}-${EnvironmentName}-CoreTable"

  SSMCommandProcessor:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 900  # 15 minutes for retries
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-ssmCommandProcessor"
      CodeUri: ../../lambdas/ssmCommandProcessor/
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt SSMCommandQueue.Arn
            BatchSize: 1
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ssm:SendCommand
                - ssm:GetCommandInvocation
                - ssm:ListCommandInvocations
              Resource:
                - !Sub 'arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*'
                - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:document/*'


Outputs:
  GraphQLAPIEndpoint:
    Value: !GetAtt GraphQLAPI.GraphQLUrl
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-GraphQLAPIEndpoint"

  GraphQLAPIId:
    Value: !GetAtt GraphQLAPI.ApiId
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-GraphQLAPIId"

  # ConfigServer output removed as Lambda is no longer needed

  GetMonthlyCost:
    Value: !GetAtt GetMonthlyCost.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-GetMonthlyCost"

  GetServerMetrics:
    Value: !GetAtt GetServerMetrics.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-GetServerMetrics"

  ListServers:
    Value: !GetAtt ListServers.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-ListServers"

  ServerAction:
    Value: !GetAtt ServerAction.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-ServerAction"

  FixServerRole:
    Value: !GetAtt FixServerRole.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-FixServerRole"

  EventResponse:
    Value: !GetAtt EventResponse.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-EventResponse"

  CalculateMonthlyRuntime:
    Value: !GetAtt CalculateMonthlyRuntime.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-CalculateMonthlyRuntime"

  SSMCommandProcessor:
    Value: !GetAtt SSMCommandProcessor.Arn
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-SSMCommandProcessor"

  SSMCommandQueueUrl:
    Value: !Ref SSMCommandQueue
    Export:
      Name: !Sub "${ProjectName}-${EnvironmentName}-SSMCommandQueueUrl"
