version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.0
  aws-sam: circleci/aws-sam-serverless@5.0

workflows:
  # Development pipeline - runs on all branches except main
  dev-pipeline:
    jobs:
      - build-and-deploy-backend:
          context: dev-aws
          name: deploy-backend-dev
          stage: dev
          filters:
            branches:
              ignore: main
      - build-and-deploy-frontend:
          context: dev-aws
          name: deploy-frontend-dev
          stage: dev
          requires:
            - deploy-backend-dev
          filters:
            branches:
              ignore: main
              
  # Production pipeline - runs only on main branch
  prod-pipeline:
    jobs:
      - build-and-deploy-backend:
          context: prod-aws
          name: deploy-backend-prod
          stage: prod
          filters:
            branches:
              only: main
      - build-and-deploy-frontend:
          context: prod-aws
          name: deploy-frontend-prod
          stage: prod
          requires:
            - deploy-backend-prod
          filters:
            branches:
              only: main

jobs:
  build-and-deploy-backend:
    docker:
      - image: cimg/python:3.13
    parameters:
      stage:
        type: string
    environment:
      AWS_DEFAULT_REGION: ${AWS_REGION:-us-west-2}
    steps:
      - checkout
      - restore_cache:
          keys:
            - sam-cache-v2-{{ .Branch }}-{{ checksum "cfn/template.yaml" }}
            - sam-cache-v2-{{ .Branch }}-
            - sam-cache-v2-
      - aws-cli/setup
      - aws-sam/install
      - run:
          name: Setup Rust
          command: |
            echo "Rust files changed, setting up Rust toolchain"
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            rustup target add x86_64-unknown-linux-musl
            sudo apt-get update
            sudo apt-get install -y musl-tools
      - run:
          name: Setup Python for SAM build
          command: |
            # Find the actual Python binary and create a symlink
            PYTHON_PATH=$(find ~/.pyenv/versions -name "python3.13" -type f 2>/dev/null | head -1)
            if [ -n "$PYTHON_PATH" ]; then
              sudo ln -sf "$PYTHON_PATH" /usr/local/bin/python3.13
              echo "Created symlink: /usr/local/bin/python3.13 -> $PYTHON_PATH"
            fi
      - run:
          name: Validate SAM template
          command: |
            cd cfn
            sam validate --lint
            sam validate --template-file templates/lambdas.yaml --lint
            sam validate --template-file templates/ec2.yaml --lint
            sam validate --template-file templates/dynamodb.yaml --lint
            sam validate --template-file templates/cognito.yaml --lint
            sam validate --template-file templates/ssm.yaml --lint
            sam validate --template-file templates/web.yaml --lint
      - run:
          name: Build SAM application
          no_output_timeout: 20m
          command: |
            set -e
            cd cfn
            # Force clean build by removing cache
            rm -rf .aws-sam
            sam build --parallel --no-cached
      - run:
          name: Deploy SAM application
          no_output_timeout: 30m
          command: |
            set -e
            cd cfn
            
            STACK_NAME="msd-<< parameters.stage >>"
            
            # Check if stack exists and is in failed state
            STACK_STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")
            
            if [[ "$STACK_STATUS" == "UPDATE_ROLLBACK_FAILED" ]]; then
              echo "Stack is in UPDATE_ROLLBACK_FAILED state. Attempting to continue rollback..."
              aws cloudformation continue-update-rollback --stack-name $STACK_NAME
              aws cloudformation wait stack-rollback-complete --stack-name $STACK_NAME
              echo "Rollback completed successfully"
            elif [[ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]]; then
              echo "ERROR: Stack is in ROLLBACK_COMPLETE state."
              echo "Manual intervention required. Either:"
              echo "  1. Delete the stack manually if safe to do so"
              echo "  2. Fix the issue and redeploy"
              exit 1
            fi
            
            # Deploy with monitoring
            export AWS_S3_USE_ARN_REGION=false
            
            # Set bucket names based on stage
            if [ "<< parameters.stage >>" = "dev" ]; then
              SUPPORT_BUCKET="${ARTIFACTS_BUCKET_DEV}"
              FRONTEND_BUCKET="${FRONTEND_BUCKET_DEV}"
            elif [ "<< parameters.stage >>" = "prod" ]; then
              SUPPORT_BUCKET="${ARTIFACTS_BUCKET_PROD}"
              FRONTEND_BUCKET="${FRONTEND_BUCKET_PROD}"
            fi
            
            sam deploy \
              --stack-name $STACK_NAME \
              --config-env << parameters.stage >> \
              --resolve-s3 \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
              --parameter-overrides "ProjectName=msd EnvironmentName=<< parameters.stage >> AppValue=minecraft SupportBucketName=$SUPPORT_BUCKET FrontendBucketName=$FRONTEND_BUCKET" \
              --no-confirm-changeset \
              --no-fail-on-empty-changeset \
              --disable-rollback &
            
            DEPLOY_PID=$!
            
            # Monitor stack events while deployment runs
            echo "Monitoring CloudFormation deployment progress..."
            while kill -0 $DEPLOY_PID 2>/dev/null; do
              aws cloudformation describe-stack-events \
                --stack-name $STACK_NAME \
                --query 'StackEvents[0:5].[Timestamp,LogicalResourceId,ResourceStatus,ResourceStatusReason]' \
                --output table 2>/dev/null || true
              sleep 60
            done
            
            # Wait for deployment to complete and get exit code
            wait $DEPLOY_PID
      - run:
          name: Get stack outputs
          command: |
            cd cfn
            aws cloudformation describe-stacks \
              --stack-name msd-<< parameters.stage >> \
              --query 'Stacks[0].Outputs' \
              --output table
      - run:
          name: Build Rust binaries
          command: |
            echo "Building Rust binaries"
            source $HOME/.cargo/env
            cd rust/msd-metrics
            cargo build --release --target x86_64-unknown-linux-musl
            cp target/x86_64-unknown-linux-musl/release/msd-metrics ../../
            
            cd ../msd-logs
            cargo build --release --target x86_64-unknown-linux-musl
            cp target/x86_64-unknown-linux-musl/release/msd-logs ../../
      - run:
          name: Upload Rust binaries and scripts to SupportBucket
          command: |
            # Get bucket name from CloudFormation stack outputs
            SUPPORT_BUCKET=$(aws cloudformation describe-stacks \
              --stack-name msd-<< parameters.stage >> \
              --query 'Stacks[0].Outputs[?OutputKey==`SupportBucket`].OutputValue' \
              --output text)
            
            echo "Using support bucket: $SUPPORT_BUCKET"
            
            # Get script version
            SCRIPT_VERSION=$(cat scripts/VERSION)
            echo "Script version: $SCRIPT_VERSION"
            
            echo "Uploading Rust binaries to s3://$SUPPORT_BUCKET/"
            aws s3 cp msd-metrics "s3://$SUPPORT_BUCKET/msd-metrics"
            aws s3 cp msd-logs "s3://$SUPPORT_BUCKET/msd-logs"
            
            echo "Uploading bootstrap scripts to s3://$SUPPORT_BUCKET/scripts/v${SCRIPT_VERSION}/"
            if [ -d "scripts" ]; then
              aws s3 sync scripts/ "s3://$SUPPORT_BUCKET/scripts/v${SCRIPT_VERSION}/" --delete
            fi
            
            # Also upload to 'latest' for convenience
            echo "Uploading to s3://$SUPPORT_BUCKET/scripts/latest/"
            aws s3 sync scripts/ "s3://$SUPPORT_BUCKET/scripts/latest/" --delete
      - run:
          name: Upload CloudWatch agent config
          command: |
            # Get bucket name from CloudFormation stack outputs
            SUPPORT_BUCKET=$(aws cloudformation describe-stacks \
              --stack-name msd-<< parameters.stage >> \
              --query 'Stacks[0].Outputs[?OutputKey==`SupportBucket`].OutputValue' \
              --output text)
            
            if [ -f "amazon-cloudwatch-agent.json" ]; then
              echo "Uploading CloudWatch agent config to s3://$SUPPORT_BUCKET/"
              aws s3 cp amazon-cloudwatch-agent.json "s3://$SUPPORT_BUCKET/amazon-cloudwatch-agent.json"
            fi

      - save_cache:
          key: sam-cache-v2-{{ .Branch }}-{{ checksum "cfn/template.yaml" }}
          paths:
            - ~/.aws-sam
            - cfn/.aws-sam

  build-and-deploy-frontend:
    docker:
      - image: cimg/node:20.18
    parameters:
      stage:
        type: string
    environment:
      AWS_DEFAULT_REGION: ${AWS_REGION:-us-west-2}
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-cache-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
            - npm-cache-{{ .Branch }}-
      - aws-cli/setup
      - run:
          name: Get stack configuration
          command: |
            set -e
            # Run create-env-from-cfn-stack.sh to generate .env file
            chmod +x support_tasks/create-env-from-cfn-stack.sh
            ./support_tasks/create-env-from-cfn-stack.sh msd-<< parameters.stage >> ${AWS_DEFAULT_REGION}
      - run:
          name: Build frontend
          command: |
            set -e
            cd webapp
            npm ci
            npm run build
      - run:
          name: Deploy to S3 and invalidate CloudFront
          command: |
            set -e
            
            # Use environment variables from CircleCI project settings
            if [ "<< parameters.stage >>" = "dev" ]; then
              BUCKET_NAME="${FRONTEND_BUCKET_DEV}"
              CLOUDFRONT_ID="${CLOUDFRONT_DISTRIBUTION_DEV}"
            elif [ "<< parameters.stage >>" = "prod" ]; then
              BUCKET_NAME="${FRONTEND_BUCKET_PROD}"
              CLOUDFRONT_ID="${CLOUDFRONT_DISTRIBUTION_PROD}"
            fi
            
            echo "Deploying to S3 bucket: $BUCKET_NAME"
            aws s3 sync webapp/dist/ s3://$BUCKET_NAME --delete
            
            if [ -n "$CLOUDFRONT_ID" ]; then
              echo "Invalidating CloudFront distribution: $CLOUDFRONT_ID"
              aws cloudfront create-invalidation \
                --distribution-id $CLOUDFRONT_ID \
                --paths "/*"
            fi
      - save_cache:
          key: npm-cache-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
          paths:
            - ~/.npm
