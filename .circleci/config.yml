version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.0
  aws-sam: circleci/aws-sam-serverless@4.0

workflows:
  dev-pipeline:
    jobs:
      - build-and-deploy-sam:
          context: dev-aws
          name: deploy-sam-dev
          stage: dev
          filters:
            branches:
              only: dev
      - build-and-deploy-frontend:
          context: dev-aws
          name: deploy-frontend-dev
          stage: dev
          requires:
            - deploy-sam-dev
          filters:
            branches:
              only: dev
              
  prod-pipeline:
    jobs:
      - build-and-deploy-sam:
          context: prod-aws
          name: deploy-sam-prod
          stage: prod
          filters:
            branches:
              only: main
      - build-and-deploy-frontend:
          context: prod-aws
          name: deploy-frontend-prod
          stage: prod
          requires:
            - deploy-sam-prod
          filters:
            branches:
              only: main

jobs:
  build-and-deploy-sam:
    docker:
      - image: cimg/python:3.13
    parameters:
      stage:
        type: string
    environment:
      AWS_DEFAULT_REGION: us-west-2
    steps:
      - checkout
      - restore_cache:
          keys:
            - sam-cache-v2-{{ .Branch }}-{{ checksum "cfn/template.yaml" }}
            - sam-cache-v2-{{ .Branch }}-
            - sam-cache-v2-
      - aws-cli/setup
      - aws-sam/install
      - run:
          name: Setup Python for SAM build
          command: |
            # Find the actual Python binary and create a symlink
            PYTHON_PATH=$(find ~/.pyenv/versions -name "python3.13" -type f 2>/dev/null | head -1)
            if [ -n "$PYTHON_PATH" ]; then
              sudo ln -sf "$PYTHON_PATH" /usr/local/bin/python3.13
              echo "Created symlink: /usr/local/bin/python3.13 -> $PYTHON_PATH"
            fi
      - run:
          name: Validate SAM template
          command: |
            cd cfn
            sam validate
      - run:
          name: Build SAM application
          no_output_timeout: 20m
          command: |
            set -e
            cd cfn
            # Force clean build by removing cache
            rm -rf .aws-sam
            sam build --parallel --no-cached
      - run:
          name: Deploy SAM application
          no_output_timeout: 30m
          command: |
            set -e
            cd cfn
            
            STACK_NAME="msd-<< parameters.stage >>"
            
            # Check if stack exists and is in failed state
            STACK_STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")
            
            if [[ "$STACK_STATUS" == *"FAILED"* ]] || [[ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]]; then
              echo "Stack is in failed state: $STACK_STATUS. Deleting..."
              aws cloudformation delete-stack --stack-name $STACK_NAME
              aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME
              echo "Stack deleted successfully"
            fi
            
            # Deploy with monitoring
            sam deploy \
              --stack-name $STACK_NAME \
              --config-env << parameters.stage >> \
              --resolve-s3 \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
              --parameter-overrides "ProjectName=msd EnvironmentName=<< parameters.stage >> AppValue=minecraft" \
              --no-confirm-changeset \
              --no-fail-on-empty-changeset &
            
            DEPLOY_PID=$!
            
            # Monitor stack events while deployment runs
            echo "Monitoring CloudFormation deployment progress..."
            while kill -0 $DEPLOY_PID 2>/dev/null; do
              aws cloudformation describe-stack-events \
                --stack-name $STACK_NAME \
                --query 'StackEvents[0:5].[Timestamp,LogicalResourceId,ResourceStatus,ResourceStatusReason]' \
                --output table 2>/dev/null || true
              sleep 60
            done
            
            # Wait for deployment to complete and get exit code
            wait $DEPLOY_PID
      - run:
          name: Get stack outputs
          command: |
            cd cfn
            aws cloudformation describe-stacks \
              --stack-name msd-<< parameters.stage >> \
              --query 'Stacks[0].Outputs' \
              --output table
      - run:
          name: Upload CloudWatch agent config
          command: |
            SUPPORT_BUCKET=$(aws cloudformation describe-stacks \
              --stack-name msd-<< parameters.stage >> \
              --query 'Stacks[0].Outputs[?OutputKey==`SupportBucket`].OutputValue' \
              --output text)
            
            if [ -f "amazon-cloudwatch-agent.json" ]; then
              echo "Uploading CloudWatch agent config to s3://$SUPPORT_BUCKET/"
              aws s3 cp amazon-cloudwatch-agent.json "s3://$SUPPORT_BUCKET/amazon-cloudwatch-agent.json"
            fi
      - save_cache:
          key: sam-cache-v2-{{ .Branch }}-{{ checksum "cfn/template.yaml" }}
          paths:
            - ~/.aws-sam
            - cfn/.aws-sam

  build-and-deploy-frontend:
    docker:
      - image: cimg/node:20.18
    parameters:
      stage:
        type: string
    environment:
      AWS_DEFAULT_REGION: us-west-2
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-cache-{{ .Branch }}-{{ checksum "dashboard/package-lock.json" }}
            - npm-cache-{{ .Branch }}-
      - aws-cli/setup
      - run:
          name: Get stack configuration
          command: |
            set -e
            # Run get-stack-config.sh to generate .env file
            chmod +x get-stack-config.sh
            ./get-stack-config.sh msd-<< parameters.stage >> us-west-2
      - run:
          name: Build frontend
          command: |
            set -e
            cd dashboard
            npm ci
            npm run build
      - run:
          name: Deploy to S3 and invalidate CloudFront
          command: |
            set -e
            
            # Get bucket name from stack outputs
            BUCKET_NAME=$(aws cloudformation describe-stacks \
              --stack-name msd-<< parameters.stage >> \
              --query 'Stacks[0].Outputs[?OutputKey==`WebAppBucket`].OutputValue' \
              --output text)
            
            CLOUDFRONT_ID=$(aws cloudformation describe-stacks \
              --stack-name msd-<< parameters.stage >> \
              --query 'Stacks[0].Outputs[?OutputKey==`CloudFront`].OutputValue' \
              --output text 2>/dev/null || echo "")
            
            echo "Deploying to S3 bucket: $BUCKET_NAME"
            aws s3 sync dashboard/dist/ s3://$BUCKET_NAME --delete
            
            if [ -n "$CLOUDFRONT_ID" ]; then
              echo "Invalidating CloudFront distribution: $CLOUDFRONT_ID"
              aws cloudfront create-invalidation \
                --distribution-id $CLOUDFRONT_ID \
                --paths "/*"
            fi
      - save_cache:
          key: npm-cache-{{ .Branch }}-{{ checksum "dashboard/package-lock.json" }}
          paths:
            - ~/.npm
