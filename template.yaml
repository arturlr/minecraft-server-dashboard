AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  Minecraft Server Dasboard

  Root stack for managing resources

Globals:
  Function:
    AutoPublishAlias: live
    Handler: index.handler
    MemorySize: 256
    Runtime: python3.10
    Timeout: 120
    Tracing: Active    
  
Parameters:
  ProjectName:
    Type: String
    Default: minecraft-dashboard
  EnvironmentName:
    Type: String
    Default: dev
    Description: A description to identify environment (e.g. dev, prod)
  AppValue:
    Type: String
    Default: minecraft
  AdminEmail:
    Type: String
    Description: Email (Gmail) that is going to be identified as the app admin
    AllowedPattern: '[^@]+@[^@]+\.[^@]+'

Resources:
  Ec2MinecraftDashboardInstanceRole:
    Type: "AWS::IAM::Role"
    Properties:
      Description: EC2 MinecraftDashboard Role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: cloudwatchMetric
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "cloudwatch:PutMetricData"
                  - "cloudwatch:List*"
                  - "cloudwatch:Get*"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "ssm:DescribeParameters"
                  - "ssm:PutParameter"
                  - "ssm:GetParameter"
                Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/minecraft*"

      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  IAMEC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub AWSEC2MinecraftProfile-${AWS::Region}
      Roles:
        - !Ref Ec2MinecraftDashboardInstanceRole

  AmazonCloudWatchLinuxParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /minecraftserverdashboard/amazoncloudwatch-linux
      Type: String
      Value: '{ "agent": { "metrics_collection_interval": 60, "run_as_user": "root" }, "logs": { "logs_collected": { "files": { "collect_list": [ { "file_path": "/opt/minecraft/server/logs/latest.log", "log_group_name": "/minecraft/serverlog/{instance_id}", "retention_in_days": 3, "filters": [ { "type": "include", "expression": "Server thread/INFO" } ] } ] } } }, "metrics": { "append_dimensions": { "AutoScalingGroupName": "${aws:AutoScalingGroupName}", "InstanceId": "${aws:InstanceId}" }, "metrics_collected": { "collectd": { "metrics_aggregation_interval": 60 }, "cpu": { "measurement": [ "cpu_usage_active" ], "resources": [ "*" ], "metrics_collection_interval": 60 }, "net": { "measurement": [ "net_bytes_sent" ], "metrics_collection_interval": 60 }, "mem": { "measurement": [ "mem_used_percent" ], "metrics_collection_interval": 60 }, "statsd": { "metrics_aggregation_interval": 60, "metrics_collection_interval": 10, "service_address": ":8125" } } } }'
      Description: Amazon CloudWatch agent config

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub ${ProjectName}-${EnvironmentName}-userpool
      Policies:
        PasswordPolicy:
          MinimumLength: 8
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      Schema:
        - AttributeDataType: String
          Name: email
          Required: true
        - AttributeDataType: String
          Name: family_name
          Required: true
        - AttributeDataType: String
          Name: given_name
          Required: true

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    DependsOn: GoogleIdentityProvider
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ClientName: !Sub ${ProjectName}-${EnvironmentName}-client
      GenerateSecret: false
      CallbackURLs:
        - http://localhost:5173/
      LogoutURLs:
        - http://localhost:5173/
      AllowedOAuthFlowsUserPoolClient: true
      ExplicitAuthFlows:
        - ALLOW_CUSTOM_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      AllowedOAuthFlows:
        - code
      SupportedIdentityProviders:
        - COGNITO
        - !Ref GoogleIdentityProvider
      AllowedOAuthScopes:
        - aws.cognito.signin.user.admin
        - email
        - openid
        - phone
        - profile

  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain:
        !Join [
          "-",
          [
            "minecraft",
            !Select [1, !Split ["-", !Select [2, !Split ["/", !Ref AWS::StackId]]],],
          ],
        ]
      UserPoolId: !Ref CognitoUserPool

  CognitoIdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub ${ProjectName}-${EnvironmentName}-identity
      AllowUnauthenticatedIdentities: true
      CognitoIdentityProviders:
        - ClientId: !Ref CognitoUserPoolClient
          ProviderName: !GetAtt CognitoUserPool.ProviderName

  # Create a role for unauthorized acces to AWS resources. Very limited access. Only allows users in the previously created Identity Pool
  CognitoUnAuthorizedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Federated: "cognito-identity.amazonaws.com"
            Action:
              - "sts:AssumeRoleWithWebIdentity"
            Condition:
              StringEquals:
                "cognito-identity.amazonaws.com:aud":
                  Ref: CognitoIdentityPool
              "ForAnyValue:StringLike":
                "cognito-identity.amazonaws.com:amr": unauthenticated

  # Create a role for authorized acces to AWS resources. Control what your user can access. This example only allows Lambda invokation
  # Only allows users in the previously created Identity Pool
  CognitoAuthorizedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Federated: "cognito-identity.amazonaws.com"
            Action:
              - "sts:AssumeRoleWithWebIdentity"
            Condition:
              StringEquals:
                "cognito-identity.amazonaws.com:aud":
                  Ref: CognitoIdentityPool
              "ForAnyValue:StringLike":
                "cognito-identity.amazonaws.com:amr": authenticated

  # Assigns the roles to the Identity Pool
  IdentityPoolRoleMapping:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref CognitoIdentityPool
      Roles:
        authenticated: !GetAtt CognitoAuthorizedRole.Arn
        unauthenticated: !GetAtt CognitoUnAuthorizedRole.Arn

  GoogleIdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Properties:
      ProviderName: Google
      UserPoolId: !Ref CognitoUserPool
      ProviderType: Google
      AttributeMapping:
        email: email
        given_name: given_name
        family_name: family_name
      ProviderDetails:
        client_id: '{{resolve:ssm:/minecraft/GOOGLE_CLIENT_ID}}'
        client_secret: '{{resolve:ssm:/minecraft/GOOGLE_SECRET}}'
        authorize_scopes: email profile openid

  ServersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiration
        Enabled: true

  LogAuditTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiration
        Enabled: true

  GraphQLAPI:
    Type: AWS::Serverless::GraphQLApi
    Properties:
      Name: !Sub ${ProjectName}-${EnvironmentName}-graphql
      SchemaUri: ./appsync/schema.graphql
      Auth:
        Type: "AMAZON_COGNITO_USER_POOLS"
        UserPool:
          UserPoolId: !Ref CognitoUserPool
          AwsRegion: !Ref "AWS::Region"
          DefaultAction: ALLOW
        Additional:
          - Type: AWS_IAM
      DataSources:
        DynamoDb:
          LogAuditTable:
            TableName: !Ref LogAuditTable
            TableArn: !GetAtt LogAuditTable.Arn
          ServersTable:
            TableName: !Ref ServersTable
            TableArn: !GetAtt ServersTable.Arn
        Lambda:
          ListServersDataSource:
            FunctionArn: !GetAtt ListServers.Arn
          ServerActionDataSource:
            FunctionArn: !GetAtt TriggerServerAction.Arn
          GetMonthlyCostDataSource:
            FunctionArn: !GetAtt GetMonthlyCost.Arn
      Functions:
        serverListFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ListServersDataSource
          CodeUri: ./appsync/resolvers/lambdaInvoker.js
        triggerServerActionFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ServerActionDataSource
          CodeUri: ./appsync/resolvers/lambdaInvoker.js     
        getMonthlyCostFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: GetMonthlyCostDataSource
          CodeUri: ./appsync/resolvers/lambdaInvoker.js
        putLogAuditFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: LogAuditTable
          CodeUri: ./appsync/resolvers/putById.js
        getLogAuditFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: LogAuditTable
          CodeUri: ./appsync/resolvers/getById.js
        putServerRecordFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ServersTable
          CodeUri: ./appsync/resolvers/putById.js
        getServerRecordFunction:
          Runtime:
            Name: APPSYNC_JS
            Version: "1.0.0"
          DataSource: ServersTable
          CodeUri: ./appsync/resolvers/getById.js
      Resolvers:
        Mutation: 
          # putServerConfig:
          #   Runtime:
          #     Name: APPSYNC_JS
          #     Version: "1.0.0"
          #   Pipeline:
          #     - triggerServerActionFunction
          putServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - putServerRecordFunction
          updateServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - triggerServerActionFunction
          startServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - triggerServerActionFunction
          stopServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - triggerServerActionFunction
          restartServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - triggerServerActionFunction
          fixServerRole:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - triggerServerActionFunction
          addUserToServer:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - triggerServerActionFunction
          putLogAudit:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - putLogAuditFunction
          verifyUserEmail:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getLogAuditFunction
        Query:
          listServers:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - serverListFunction     
          # getServerConfig:
          #   Runtime:
          #     Name: APPSYNC_JS
          #     Version: "1.0.0"
          #   Pipeline:
          #     - triggerServerActionFunction
          getServerConfig:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getServerRecordFunction
          getMonthlyCost:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getMonthlyCostFunction
          getLogAudit:
            Runtime:
              Name: APPSYNC_JS
              Version: "1.0.0"
            Pipeline:
              - getLogAuditFunction

  DataSourceNone:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      Name: dataSourceNameNone
      Description: dataSourceNone
      Type: "NONE"

  PutMetricServerResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      TypeName: Mutation
      FieldName: putServerMetric
      DataSourceName: !GetAtt DataSourceNone.Name
      RequestMappingTemplate: |
        {
          "version" : "2017-02-28",
          "payload": { 
              "id": $util.toJson($context.arguments.input.id),
              "cpuStats": $util.toJson($context.arguments.input.cpuStats),
              "networkStats": $util.toJson($context.arguments.input.networkStats),
              "memStats": $util.toJson($context.arguments.input.memStats),
              "activeUsers": $util.toJson($context.arguments.input.activeUsers),
          }
        }
      ResponseMappingTemplate: $util.toJson($ctx.result)

  ChangeServerStateResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt GraphQLAPI.ApiId
      TypeName: Mutation
      FieldName: changeServerState
      DataSourceName: !GetAtt DataSourceNone.Name
      RequestMappingTemplate: |
        {
          "version" : "2017-02-28",
          "payload": { 
              "id": $util.toJson($context.arguments.input.id),
              "name": $util.toJson($context.arguments.input.name),
              "type": $util.toJson($context.arguments.input.type),
              "userEmail": $util.toJson($context.arguments.input.userEmail),
              "state": $util.toJson($context.arguments.input.state),
              "vCpus": $util.toJson($context.arguments.input.vCpus),
              "memSize": $util.toJson($context.arguments.input.memSize),
              "diskSize": $util.toJson($context.arguments.input.diskSize),
              "launchTime": $util.toJson($context.arguments.input.launchTime),
              "publicIp": $util.toJson($context.arguments.input.publicIp),
              "initStatus": $util.toJson($context.arguments.input.initStatus),
              "iamStatus": $util.toJson($context.arguments.input.iamStatus),
              "runningMinutes": $util.toJson($context.arguments.input.runningMinutes),
              "groupMembers": $util.toJson($context.arguments.input.groupMembers)
          }
        }
      ResponseMappingTemplate: $util.toJson($ctx.result)

  SupportBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
    DeletionPolicy: Delete

  WebAppBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
    DeletionPolicy: Delete

  WebAppBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebAppBucket
      PolicyDocument:
        Statement:
          - Action: s3:GetObject
            Effect: Allow
            Resource: !Sub ${WebAppBucket.Arn}/*
            Principal:
              Service: cloudfront.amazonaws.com
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFront}

  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub ${ProjectName}-${EnvironmentName}-OAC
        Description: Default Origin Access Control
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFront:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt WebAppBucket.DomainName
            S3OriginConfig:
              OriginAccessIdentity: ""
            OriginAccessControlId: !GetAtt OriginAccessControl.Id
        Enabled: true
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: S3Origin
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none

  MineDashSSMDoc:
    Type: AWS::SSM::Document
    Properties:
      DocumentType: Command
      TargetType: /AWS::EC2::Instance
      Content:
        schemaVersion: '2.2'
        description: Bootstrap instance
        parameters:
          S3BucketName:
            type: String
            default: !Ref SupportBucket
            description: 'Name of the S3 bucket'
          S3KeyPrefix:
            type: String 
            default: amazon-cloudwatch-agent.json
            description: 'S3 key prefix for the script'
        mainSteps:              
          - action: aws:runShellScript
            name: installPackages
            inputs:
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  # Function to detect the Linux distribution
                  detect_distro() {
                      if [ -f /etc/os-release ]; then
                          . /etc/os-release
                          DISTRO=$ID
                      elif [ -f /etc/lsb-release ]; then
                          . /etc/lsb-release
                          DISTRO=$DISTRIB_ID
                      elif [ -f /etc/debian_version ]; then
                          DISTRO="debian"
                      elif [ -f /etc/redhat-release ]; then
                          DISTRO="rhel"
                      else
                          DISTRO=$(uname -s)
                      fi
                      echo $DISTRO
                  }
                  # Function to install CloudWatch agent on Amazon Linux, RHEL, or CentOS
                  install_cloudwatch_rpm() {
                      yum install -y amazon-cloudwatch-agent
                      echo "CloudWatch installed"
                  }
                  # Function to install CloudWatch agent on Ubuntu or Debian
                  install_cloudwatch_deb() {
                      apt-get update
                      apt-get install -y wget
                      wget https://amazoncloudwatch-agent.s3.amazonaws.com/debian/amd64/latest/amazon-cloudwatch-agent.deb
                      dpkg -i -E ./amazon-cloudwatch-agent.deb
                      rm amazon-cloudwatch-agent.deb
                      echo "CloudWatch installed"
                  }
                  install_awscli() {
                      if [ ! -f /usr/share/collectd/types.db ]; then
                        sudo mkdir -p /usr/share/collectd
                        sudo touch /usr/share/collectd/types.db
                      fi
                      if ! command -v aws >/dev/null 2>&1; then
                        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                        unzip awscliv2.zip
                        sudo ./aws/install
                      echo "AWS CLI installed successfully"
                      else
                          echo "AWS CLI is already installed"
                      fi 
                  }
                  # Main installation function
                  install_packages() {
                      local distro=$(detect_distro)
                      case $distro in
                          amzn*|rhel*|centos*)
                              install_cloudwatch_rpm
                              yum -y install jq zip unzip
                              ;;
                          ubuntu*|debian*)
                              install_cloudwatch_deb
                              apt-get -y install jq zip unzip net-tools
                              ;;
                          *)
                              echo "Unsupported distribution: $distro"
                              exit 1
                              ;;
                      esac
                  }
                  
                  install_packages
                  install_awscli

                  echo "Packages installed successfully" 
          - action: aws:runShellScript
            name: CloudWatchStart
            inputs:
              runCommand:
                - |
                  sudo aws s3 cp "s3://{{ S3BucketName }}/{{ S3KeyPrefix }}" /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
                  sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
                  sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -m ec2 -a status      
          - action: aws:runShellScript
            name: Cron
            inputs:
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  if [ ! -f /usr/local/port_count.sh ]; then
                    # Get instance metadata
                    INSTANCE_ID=$(ec2metadata --instance-id)
                    REGION=$(curl -s http://169.254.169.254/latest/meta-data/local-hostname | cut -d . -f 2)
                    # Count established connections on port 25565
                    PORT_COUNT=$(netstat -an | grep ESTABLISHED | grep ':25565' | wc -l)
                    # Create the script file
                    echo "#!/bin/bash" > /usr/local/port_count.sh
                    echo "INSTANCE_ID=\"$INSTANCE_ID\"" >> /usr/local/port_count.sh
                    echo "PORT_COUNT=\$(netstat -an | grep ESTABLISHED | grep ':25565' | wc -l)" >> /usr/local/port_count.sh
                    echo "REGION=\"$REGION\"" >> /usr/local/port_count.sh
                    echo "aws cloudwatch put-metric-data --metric-name UserCount --dimensions InstanceId=\$INSTANCE_ID --namespace 'MinecraftDashboard' --value \$PORT_COUNT --region \$REGION" >> /usr/local/port_count.sh
                    # Make the script executable
                    chmod +x /usr/local/port_count.sh
                    # Schedule the script to run every minute
                    (sudo crontab -l 2>/dev/null; echo "*/1 * * * * /usr/local/port_count.sh >/dev/null 2>&1") | crontab -         
                  fi  
                - sudo crontab -l
          - action: aws:runShellScript
            name: NICSSM
            inputs:
              runCommand:
                - echo "Get NIC"
                - NIC=$(ip route get 1.1.1.1 | awk '{print $5; exit}')
                - INSTANCE_ID=$(ec2metadata --instance-id)                
                - PARAM_NAME="/minecraftserverdashboard/$INSTANCE_ID/nic"
                - !Sub |
                  if aws ssm get-parameter --name "$PARAM_NAME" 2>/dev/null; then
                    echo "Parameter already exists"
                  else
                    echo "Parameter does not exist, creating $PARAM_NAME"
                    aws ssm put-parameter --name "$PARAM_NAME" --type 'String' --value "$NIC"
                  fi

  ScheduledRule: 
    Type: AWS::Events::Rule
    Properties: 
      Description: "ScheduledRule"
      ScheduleExpression: "rate(2 minutes)"
      State: "DISABLED"
      Targets: 
        - 
          Arn: !GetAtt EventResponse.Arn              
          Id: "EventResponseV1"

  ScheduledRuleParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /minecraftserverdashboard/scheduledrule
      Type: String
      Value: !Ref ScheduledRule
      Description: ScheduledRule

  PermissionForEventsToInvokeLambda: 
    Type: AWS::Lambda::Permission
    Properties: 
      FunctionName: !Ref "EventResponse"
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: 
        !GetAtt ScheduledRule.Arn

  HelperLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: MinecraftDashboardHelper
      ContentUri: ./layers/helpers/
      CompatibleRuntimes:
        - python3.10
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  EventResponse:
    Type: AWS::Serverless::Function 
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-eventResponse"
      CodeUri: ./lambdas/eventResponse/
      Layers:
        - !Ref HelperLayer
      Events:
        EC2StateTrigger:
          Type: CloudWatchEvent 
          Properties:
            Pattern:
              source:
                - aws.ec2
              detail-type:
                - EC2 Instance State-change Notification                
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: "minecraftserverdashboard*"
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - logs:Get*
                - logs:List*
                - logs:StartQuery
              Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/minecraft/*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - appsync:ListGraphqlApis
                - appsync:GetGraphqlApi
                - appsync:GraphQL
              Resource: '*'
        - Version: '2012-10-17' # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - events:ListRules
                - events:DescribeRule
                - events:DisableRule
                - events:EnableRule
              Resource: "*"
      Environment:
        Variables:
          APP_NAME: !Ref ProjectName
          TAG_APP_VALUE: !Ref AppValue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          COGNITO_USER_POOL_ID: !Ref CognitoUserPool
          #INSTANCES_TABLE_NAME: !Ref InstancesTable
          EC2_INSTANCE_PROFILE_NAME: !Ref IAMEC2InstanceProfile
          EC2_INSTANCE_PROFILE_ARN: !GetAtt IAMEC2InstanceProfile.Arn

  GetMonthlyCost:
    Type: AWS::Serverless::Function 
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-getMonthlyCost"
      CodeUri: ./lambdas/getMonthlyCost/
      Layers:
        - !Ref HelperLayer        
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: "minecraftserverdashboard*"
        # - DynamoDBCrudPolicy:
        #     TableName: !Ref InstancesTable
      Environment:
        Variables:
          APP_NAME: !Ref ProjectName
          TAG_APP_VALUE: !Ref AppValue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          #INSTANCES_TABLE_NAME: !Ref InstancesTable

  ListServers:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-listServers"
      CodeUri: ./lambdas/listServers/
      Layers:
        - !Ref HelperLayer
      Policies:
        - CostExplorerReadOnlyPolicy: {}
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AWSCloudTrail_ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: !Sub "/${ProjectName}/${EnvironmentName}*"
        # - DynamoDBCrudPolicy:
        #     TableName: !Ref InstancesTable
      Environment:
        Variables:
          APP_NAME: !Ref ProjectName
          TAG_APP_VALUE: !Ref AppValue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          #INSTANCES_TABLE_NAME: !Ref InstancesTable
          EC2_INSTANCE_PROFILE_NAME: !Ref IAMEC2InstanceProfile
          EC2_INSTANCE_PROFILE_ARN: !GetAtt IAMEC2InstanceProfile.Arn
          COGNITO_USER_POOL_ID: !Ref CognitoUserPool

  TriggerServerAction:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 300
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-triggerServerAction"
      CodeUri: ./lambdas/triggerServerAction/
      Layers:
        - !Ref HelperLayer        
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - StepFunctionsExecutionPolicy:
            StateMachineName: !GetAtt StateMachine.Name
        - SSMParameterReadPolicy:
            ParameterName: !Sub "/${ProjectName}/${EnvironmentName}*"
        # - DynamoDBCrudPolicy:
        #     TableName: !Ref InstancesTable
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - ec2:AssociateIamInstanceProfile
                - ec2:DisassociateIamInstanceProfile
                - ec2:DeleteTags
                - ec2:CreateTags
              Resource: 'arn:aws:ec2:*:*:instance/*'
              Condition:
                StringEquals:
                  'ec2:ResourceTag/App': !Ref AppValue
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt Ec2MinecraftDashboardInstanceRole.Arn
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - ssm:PutParameter
                - ssm:GetParameters
              Resource: !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/minecraftserverdashboard*
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:CreateGroup
                - cognito-idp:AdminAddUserToGroup
                - cloudwatch:PutMetricAlarm
              Resource: "*"
      Environment:
        Variables:
          StepFunctionsArn: !Ref StateMachine
          APP_NAME: !Ref ProjectName
          TAG_APP_VALUE: !Ref AppValue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          EC2_INSTANCE_PROFILE_NAME: !Ref IAMEC2InstanceProfile
          EC2_INSTANCE_PROFILE_ARN: !GetAtt IAMEC2InstanceProfile.Arn
          CONFIG_SERVER_LAMBDA_NAME: !Ref ConfigServer
          COGNITO_USER_POOL_ID: !Ref CognitoUserPool

  ChangeServerState:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-changeServerState"
      CodeUri: ./lambdas/changeServerState/
      Layers:
        - !Ref HelperLayer
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonCognitoReadOnly
        - SSMParameterReadPolicy:
            ParameterName: "minecraftserverdashboard*"
        # - DynamoDBCrudPolicy:
        #     TableName: !Ref InstancesTable
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - ec2:StartInstances
                - ec2:StopInstances
                - ec2:RebootInstances
              Resource: "*"
      Environment:
        Variables:
          APP_NAME: !Ref ProjectName
          TAG_APP_VALUE: !Ref AppValue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          COGNITO_USER_POOL_ID: !Ref CognitoUserPool
          #INSTANCES_TABLE_NAME: !Ref InstancesTable

  ConfigServer:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-configServer"
      CodeUri: ./lambdas/configServer/
      Layers:
        - !Ref HelperLayer
      Timeout: 300
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        - SSMParameterReadPolicy:
            ParameterName: "minecraft*"
        - LambdaInvokePolicy:
            FunctionName: !Ref EventResponse
        # - DynamoDBCrudPolicy:
        #     TableName: !Ref InstancesTable
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - ssm:List*
                - ssm:Describe*
                - ssm:Get*
                - ssm:SendCommand
                - ssm:CancelCommand
                - ssm:GetCommandInvocation
                - ec2:AssociateIamInstanceProfile
                - ec2:DisassociateIamInstanceProfile
              Resource: "*"
        - Version: "2012-10-17" # Policy Document
          Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !GetAtt Ec2MinecraftDashboardInstanceRole.Arn
      Environment:
        Variables:
          APP_NAME: !Ref ProjectName
          TAG_APP_VALUE: !Ref AppValue
          APPSYNC_URL: !GetAtt GraphQLAPI.GraphQLUrl
          EVENT_RESPONSE_LAMBDA: !Ref EventResponse
          #INSTANCES_TABLE_NAME: !Ref InstancesTable

  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/states/${ProjectName}-StateMachine-LogGroup-${AWS::Region}"
      RetentionInDays: 7

  StateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: ./step-functions.json
      DefinitionSubstitutions:
        changeServerState: !GetAtt ChangeServerState.Arn
        configServer: !GetAtt ConfigServer.Arn
      Role: !GetAtt StatesExecutionRole.Arn
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StateMachineLogGroup.Arn         

  StatesExecutionRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - !Sub states.${AWS::Region}.amazonaws.com
            Action: "sts:AssumeRole"
      Path: "/"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
      Policies:
        - PolicyName: steprolep1
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                  - ssm:SendCommand
                  - ssm:List*
                  - ssm:Get*
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: "*"

Outputs:
  IdentityPoolId:
    Description: Cognito IdentityPool Id
    Value: !Ref CognitoIdentityPool

  CognitoUserPoolClientId:
    Description: Cognito UserPool ClientId
    Value: !Ref CognitoUserPoolClient

  CognitoUserPoolId:
    Description: Cognito UserPool Id
    Value: !Ref CognitoUserPool

  CognitoDomainName:
    Description: Cognito DomainName
    Value: !Ref UserPoolDomain

  CloudFrontUrl:
    Description: CloudFront Url
    Value: !GetAtt CloudFront.DomainName

  AppSyncUrl:
    Description: AppSync Url
    Value: !GetAtt GraphQLAPI.GraphQLUrl

  WebAppBucketName:
    Description: S3 Web Bucket Name
    Value: !Ref WebAppBucket

  SupportBucketName:
    Description: S3 Support Bucket Name
    Value: !Ref SupportBucket
