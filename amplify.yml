version: 1
backend:
  phases:
    build:
      commands:
        - '# Execute Amplify CLI with the helper script'
        - amplifyPush --simple
frontend:
  phases:
    preBuild:
      commands:
        - npm install --save vue-apexcharts apexcharts
    build:
      commands:
        - npm run build
    postBuild:
      commands:
        - yum install -y jq
        - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        - unzip awscliv2.zip
        - ./aws/install
        - DATE_SUFFIX=$(date +%y%m%d-%H%M)
        - DATE_TICKS=$(date +%s)
        - TICK_SUFFIX=${DATE_TICKS:6:4}
        - APP_ID=$(aws amplify list-apps --query 'apps[*].[appId, name]' --output text | awk '/minecraft/ {print $1}')
        - POOL_ID=$(aws ssm get-parameter --name /amplify/minecraftserverdashboard/userpoolid --query Parameter.Value --output text)
        - APP_URL="https://${AWS_BRANCH}.${APP_ID}.amplifyapp.com"
        - jq -n --arg url "$APP_URL" '{RefreshTokenValidity:30, TokenValidityUnits:{ RefreshToken:"days" }, SupportedIdentityProviders:[ "Google", "COGNITO" ], CallbackURLs:[ $url ], LogoutURLs:[ $url ], AllowedOAuthFlows:[ "code" ], AllowedOAuthScopes:[ "aws.cognito.signin.user.admin", "phone", "openid", "profile", "email" ], AllowedOAuthFlowsUserPoolClient:false }' > param.json 
        - COG_CLIENTS=($(aws cognito-idp list-user-pool-clients --user-pool-id ${POOL_ID} --query 'UserPoolClients[].[ClientId]' --output text))
        - COG_DOMAIN=$(aws cognito-idp describe-user-pool --user-pool-id ${POOL_ID} --query UserPool.Domain --output text)
        - AWS_REGION=$(aws cognito-idp describe-user-pool --user-pool-id ${POOL_ID} --query UserPool.Arn --output text | cut -d ':' -f 4)
        - '# Add Amplify URL to the Cognito clients callback and logout configurations - Bash Array'      
        - aws cognito-idp update-user-pool-client --user-pool-id ${POOL_ID} --client-id ${COG_CLIENTS[2]} --cli-input-json file://param.json
        - '# Making sure that the minecraftdashboard cognito domain is unique'
        - aws cognito-idp delete-user-pool-domain --user-pool-id ${POOL_ID} --domain ${COG_DOMAIN}
        - aws cognito-idp create-user-pool-domain --user-pool-id ${POOL_ID} --domain minecraftdashboard-${TICK_SUFFIX}
        - echo "Cognito Domain - minecraftdashboard-${TICK_SUFFIX}.auth.${AWS_REGION}.amazoncognito.com"
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
