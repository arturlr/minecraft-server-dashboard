version: 1
backend:
  phases:
    preBuild:
      commands:
        - yum install -y jq
        - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        - unzip awscliv2.zip
        - ./aws/install
        - POOL_ID=$(aws ssm get-parameter --name /amplify/minecraftserverdashboard/userpoolid --query Parameter.Value --output text)
        - APP_ID=$(aws amplify list-apps --query 'apps[*].[appId, name]' --output text | awk '/minecraft/ {print $1}')
    build:
      commands:
        - '# Execute Amplify CLI with the helper script'
        - amplifyPush --simple
    postBuild:
      commands:        
        - COG_DOMAIN=$(aws cognito-idp describe-user-pool --user-pool-id ${POOL_ID} --query UserPool.Domain --output text)
        - AWS_REGION=$(aws cognito-idp describe-user-pool --user-pool-id ${POOL_ID} --query UserPool.Arn --output text | cut -d ':' -f 4)
        - '# Making sure that the minecraftdashboard cognito domain is unique by adding the first 5 digits of the app id'
        - aws cognito-idp delete-user-pool-domain --user-pool-id ${POOL_ID} --domain ${COG_DOMAIN}
        - aws cognito-idp create-user-pool-domain --user-pool-id ${POOL_ID} --domain minecraftdashboard-${APP_ID:0:5}
        - echo "Cognito Domain - minecraftdashboard-${APP_ID:0:5}.auth.${AWS_REGION}.amazoncognito.com"
frontend:
  phases:
    preBuild:
      commands:
        - npm install --save vue-apexcharts apexcharts
    build:
      commands:
        - npm run build
    postBuild:
      commands:        
        - APP_URL="https://${AWS_BRANCH}.${APP_ID}.amplifyapp.com"
        - jq -n --arg url $APP_URL '{RefreshTokenValidity:30, TokenValidityUnits:{ RefreshToken:"days" }, SupportedIdentityProviders:[ "Google", "COGNITO" ], CallbackURLs:[ $url ], LogoutURLs:[ $url ], AllowedOAuthFlows:[ "code" ], AllowedOAuthScopes:[ "aws.cognito.signin.user.admin", "phone", "openid", "profile", "email" ], AllowedOAuthFlowsUserPoolClient:false }' > param.json 
        - cat param.json
        - COG_CLIENTS=$(aws cognito-idp list-user-pool-clients --user-pool-id ${POOL_ID} --query 'UserPoolClients[].[ClientId]' --output text)
        - echo $COG_CLIENTS       
        - '# Add Amplify URL to the Cognito clients callback and logout configurations'
        - while IFS= read -r line ; do aws cognito-idp update-user-pool-client --user-pool-id ${POOL_ID} --client-id $line --cli-input-json file://param.json; done <<< "$COG_CLIENTS"        
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
