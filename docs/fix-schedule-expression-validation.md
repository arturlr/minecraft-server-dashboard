# Fix Schedule Expression Validation Error

## Problem
When configuring schedule-based server shutdown, users encounter the error:
```
Parameter ScheduleExpression is not valid
```

This occurs when the serverAction Lambda tries to create EventBridge rules with cron expressions.

## Root Cause
The issue stems from a format mismatch between the cron expressions generated by the frontend and what EventBridge expects:

1. **Frontend generates**: Standard 5-field cron expressions like `30 14 * * 1,2,3`
2. **EventBridge expects**: 6-field cron expressions wrapped in `cron()` like `cron(30 14 * * 1,2,3 *)`

## Solution
Enhanced the `ec2Helper.py` to properly validate and format cron expressions for EventBridge compatibility.

### Key Changes

#### 1. Added Schedule Expression Formatting (`layers/ec2Helper/ec2Helper.py`)
```python
def _format_schedule_expression(self, cron_expression):
    """
    Format and validate cron expression for EventBridge.
    Converts standard 5-field cron to EventBridge 6-field format.
    """
    # Handles both standard cron and EventBridge formats
    # Validates field values and ranges
    # Returns properly formatted EventBridge expression
```

#### 2. Enhanced Validation Logic
- **Field Validation**: Validates minutes (0-59), hours (0-23), day-of-week (0-6)
- **Format Support**: Handles comma-separated values, ranges, and wildcards
- **Error Handling**: Provides clear error messages for invalid expressions

#### 3. Updated Event Configuration Functions
```python
def configure_shutdown_event(self, instance_id, cron_expression):
    # Now validates and formats cron expression before creating EventBridge rule
    formatted_schedule = self._format_schedule_expression(cron_expression)
    if not formatted_schedule:
        raise ValueError(f"Invalid cron expression: {cron_expression}")
```

#### 4. Improved Error Handling in ServerAction Lambda
```python
try:
    ec2_utils.configure_shutdown_event(instance_id, stop_schedule)
except ValueError as ve:
    return utl.response(400, {"err": f"Invalid schedule expression: {str(ve)}"})
```

## Supported Cron Expression Formats

### Input Formats (Frontend)
- `30 14 * * 1,2,3` - 2:30 PM on Mon, Tue, Wed
- `0 9 * * 0` - 9:00 AM on Sunday
- `15 22 * * 1-5` - 10:15 PM on weekdays

### Output Format (EventBridge)
- `cron(30 14 * * 1,2,3 *)` - EventBridge compatible
- `cron(0 9 * * 0 *)` - EventBridge compatible
- `cron(15 22 * * 1-5 *)` - EventBridge compatible

## Validation Rules

### Time Fields
- **Minutes**: 0-59
- **Hours**: 0-23 (24-hour format)
- **Day of Month**: 1-31 or * (not validated for month-specific limits)
- **Month**: 1-12 or *
- **Day of Week**: 0-6 (0=Sunday) or *

### Special Characters
- **Comma (,)**: Multiple values (e.g., `1,3,5`)
- **Dash (-)**: Ranges (e.g., `1-5`)
- **Asterisk (*)**: Any value
- **Slash (/)**: Step values (e.g., `*/2`)

## Testing

### Test Script
Created `layers/ec2Helper/test_cron_validation.py` to validate the formatting logic:

```bash
cd layers/ec2Helper
python test_cron_validation.py
```

### Test Cases
- ✅ Standard 5-field cron expressions
- ✅ Already formatted EventBridge expressions
- ✅ Complex expressions with ranges and lists
- ❌ Invalid field values (out of range)
- ❌ Malformed expressions

## Deployment

1. **Update Lambda Layer**:
   ```bash
   cd cfn
   sam build
   sam deploy
   ```

2. **Test Schedule Configuration**:
   - Open ServerSettings dialog
   - Select "Schedule" shutdown method
   - Configure days and times
   - Save configuration
   - Verify no "ScheduleExpression is not valid" errors

## Expected Behavior After Fix

### Schedule Configuration
- ✅ Frontend generates valid cron expressions
- ✅ Backend validates and formats expressions correctly
- ✅ EventBridge rules created successfully
- ✅ Server shutdown/start schedules work as configured

### Error Handling
- ✅ Clear error messages for invalid expressions
- ✅ Validation prevents malformed schedules
- ✅ Graceful handling of edge cases

## Common Schedule Examples

### Daily Schedules
- **Every day at 11 PM**: `0 23 * * *` → `cron(0 23 * * * *)`
- **Weekdays at 6 PM**: `0 18 * * 1-5` → `cron(0 18 * * 1-5 *)`

### Weekly Schedules
- **Monday and Friday at 10:30 PM**: `30 22 * * 1,5` → `cron(30 22 * * 1,5 *)`
- **Weekend at 2 AM**: `0 2 * * 0,6` → `cron(0 2 * * 0,6 *)`

### Time Zone Considerations
- All times are in UTC
- Frontend should display timezone information to users
- Consider daylight saving time changes

## Troubleshooting

### Issue: "Invalid cron expression" error
**Solution**: Check that time values are within valid ranges and format is correct

### Issue: Schedule not triggering
**Solution**: Verify EventBridge rules are created and enabled in AWS console

### Issue: Wrong timezone
**Solution**: Ensure frontend converts local time to UTC before sending to backend

## Future Enhancements

1. **Timezone Support**: Allow users to specify timezone for schedules
2. **Schedule Preview**: Show next execution times in the UI
3. **Advanced Patterns**: Support for more complex cron patterns
4. **Schedule History**: Track when schedules were executed